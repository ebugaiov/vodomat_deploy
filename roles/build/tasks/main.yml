---
- name: Deploy registry service
  block:
    - name: Add label to node
      community.docker.docker_node:
        hostname: "{{ inventory_hostname }}"
        labels:
          role: registry

    - name: Dir for images
      ansible.builtin.file:
        path: "/home/{{ sudo_user }}/registry"
        state: directory
        mode: '0755'

    - name: Run registry service
      community.docker.docker_swarm_service:
        name: registry
        image: registry:latest
        networks:
          - name: "{{ server_network_name }}"
        mounts:
          - source: "/home/{{ sudo_user }}/registry"
            target: /var/docker/registry
            type: bind
        placement:
          constraints:
            - node.labels.role == registry
        publish:
          - mode: ingress
            protocol: tcp
            published_port: 5000
            target_port: 5000
        env:
          REGISTRY_HTTP_ADDR: "0.0.0.0:5000"

- name: Copy ssh-key
  ansible.builtin.copy:
    src: "~/.ssh/id_rsa"
    dest: "/home/{{ sudo_user }}/.ssh/id_rsa"
    mode: "0600"

- name: "[{{ build_service_name }}] Clone github repo"
  ansible.builtin.git:
    repo: "{{ github_url_base }}/{{ build_service_name }}.git"
    accept_newhostkey: true
    dest: "{{ build_temp_folder }}"

- name: "[{{ build_service_name }}] Build image"
  community.docker.docker_image:
    name: "{{ registry_name }}/{{ build_service_name }}"
    tag: "{{ build_service_tag }}"
    push: true
    build:
      path: "{{ build_temp_folder }}"
    source: build

- name: Delete temp folder for build
  ansible.builtin.file:
    state: absent
    path: "{{ build_temp_folder }}"

- name: Delete ssh-key
  ansible.builtin.file:
    state: absent
    path: "/home/{{ sudo_user }}/.ssh/id_rsa"
